# Lima VM configuration for Cistern testing
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
arch: "aarch64"
memory: "4GiB"
disk: "20GiB"
mounts:
  - location: "."
    writable: true
portForwards:
  - guestPort: 80
    hostPort: 8090
  - guestPort: 8080
    hostPort: 8080
  - guestPort: 8096
    hostPort: 8096
  - guestPort: 8989
    hostPort: 8989
  - guestPort: 7878
    hostPort: 7878
  - guestPort: 9696
    hostPort: 9696
  - guestPort: 6767
    hostPort: 6767
  - guestPort: 9091
    hostPort: 9091
provision:
  - mode: system
    script: |
      #!/bin/bash
      # Install Nix
      curl -L https://nixos.org/nix/install | sh -s -- --daemon
      
      # Enable flakes
      mkdir -p /etc/nix
      echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
      
      # Restart nix daemon
      systemctl restart nix-daemon
      
      echo "✅ Nix installed with flakes support"
  - mode: user
    script: |
      #!/bin/bash
      # Source Nix
      . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      
      # Test Nix
      nix --version
      
      echo "✅ Lima VM ready for Cistern testing"
